{% extends "base.html" %}

{% block title %}Conversation Bot - History{% endblock %}

{% block content %}
<div class="container">
    <div class="history-container">
        <div class="history-header">
            <h2>Conversation History</h2>
            <a href="{{ url_for('index') }}" class="btn secondary-btn">Back to Home</a>
        </div>
        
        <div class="filter-container">
            <h3>Filters</h3>
            <form action="{{ url_for('history') }}" method="get" class="filter-form">
                <div class="filter-group">
                    <label for="type">Type:</label>
                    <select name="type" id="type">
                        <option value="">All</option>
                        <option value="manual" {% if conv_type == 'manual' %}selected{% endif %}>Manual</option>
                        <option value="auto" {% if conv_type == 'auto' %}selected{% endif %}>Auto</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="flow_id">Flow ID:</label>
                    <select name="flow_id" id="flow_id">
                        <option value="">All</option>
                        {% for fid in unique_flow_ids %}
                        <option value="{{ fid }}" {% if flow_id == fid %}selected{% endif %}>{{ fid }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="intent">Intent:</label>
                    <select name="intent" id="intent">
                        <option value="">All</option>
                        {% for i in unique_intents %}
                        <option value="{{ i }}" {% if intent == i %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sort_by">Sort By:</label>
                    <select name="sort_by" id="sort_by">
                        <option value="timestamp" {% if sort_by == 'timestamp' %}selected{% endif %}>Date</option>
                        <option value="flow_id" {% if sort_by == 'flow_id' %}selected{% endif %}>Flow ID</option>
                        <option value="intent" {% if sort_by == 'intent' %}selected{% endif %}>Intent</option>
                        <option value="type" {% if sort_by == 'type' %}selected{% endif %}>Type</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sort_order">Order:</label>
                    <select name="sort_order" id="sort_order">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button type="submit" class="btn primary-btn">Apply Filters</button>
                    <a href="{{ url_for('history') }}" class="btn secondary-btn">Clear Filters</a>
                </div>
            </form>
        </div>
        
        <div class="conversation-list">
            {% if conversations %}
                {% for conversation in conversations %}
                <div class="conversation-card" data-type="{{ conversation.metadata.type }}">
                    <div class="conversation-header">
                        <h3>Conversation {{ conversation.id[:8] }}...</h3>
                        <span class="conversation-type {{ conversation.metadata.type }}">{{ conversation.metadata.type|capitalize }}</span>
                    </div>
                    <div class="conversation-info">
                        <p><strong>Date:</strong> {{ conversation.date }}</p>
                        <p><strong>Flow ID:</strong> {{ conversation.metadata.flow_id }}</p>
                        <p><strong>Intent:</strong> {{ conversation.metadata.intent }}</p>
                        <p><strong>Messages:</strong> {{ conversation.summary.message_count }}</p>
                    </div>
                    <div class="conversation-preview">
                        {% if conversation.summary.first_message %}
                        <p><strong>First message:</strong> "{{ conversation.summary.first_message }}"</p>
                        {% endif %}
                        {% if conversation.summary.last_message %}
                        <p><strong>Last message:</strong> "{{ conversation.summary.last_message }}"</p>
                        {% endif %}
                    </div>
                    <div class="conversation-actions">
                        <a href="{{ url_for('view_conversation', conversation_id=conversation.id) }}" class="btn primary-btn">View</a>
                        <form action="{{ url_for('delete_conversation', conversation_id=conversation.id) }}" method="post" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this conversation?');">
                            <button type="submit" class="btn danger-btn">Delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                <div class="pagination">
                    {% if page > 1 %}
                    <a href="{{ url_for('history', page=page-1, type=conv_type, flow_id=flow_id, intent=intent, sort_by=sort_by, sort_order=sort_order) }}" class="btn secondary-btn">Previous</a>
                    {% endif %}
                    
                    <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
                    
                    {% if page < total_pages %}
                    <a href="{{ url_for('history', page=page+1, type=conv_type, flow_id=flow_id, intent=intent, sort_by=sort_by, sort_order=sort_order) }}" class="btn secondary-btn">Next</a>
                    {% endif %}
                </div>
            {% else %}
                <div class="no-conversations">
                    <p>No conversations found.</p>
                    <p>Start a new conversation from the <a href="{{ url_for('index') }}">home page</a>.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}